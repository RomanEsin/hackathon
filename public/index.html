<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Welcome to Firebase Hosting</title>

    <!-- update the version number as needed -->
    <!-- <script defer src="/__/firebase/7.21.1/firebase-app.js"></script> -->
    <!-- include only the Firebase features as you need -->
    <!-- <script defer src="/__/firebase/7.21.1/firebase-auth.js"></script> -->
    <!-- <script defer src="/__/firebase/7.21.1/firebase-database.js"></script> -->
    <!-- <script defer src="/__/firebase/7.21.1/firebase-messaging.js"></script> -->
    <!-- <script defer src="/__/firebase/7.21.1/firebase-storage.js"></script> -->
    <!-- <script defer src="/__/firebase/7.21.1/firebase-analytics.js"></script> -->
    <!-- <script defer src="/__/firebase/7.21.1/firebase-remote-config.js"></script> -->
    <!-- <script defer src="/__/firebase/7.21.1/firebase-performance.js"></script> -->
    <!-- <script src="https://www.gstatic.com/firebasejs/7.22.0/firebase-app.js"></script> -->
    <!-- <script src="https://www.gstatic.com/firebasejs/7.22.0/firebase-firestore.js"></script> -->
    <!-- initialize the SDK after all desired features are loaded -->
    <!-- <script defer src="/__/firebase/init.js"></script> -->

    <style media="screen">
      body { background: #ECEFF1; color: rgba(0,0,0,0.87); font-family: Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
      #message { background: white; max-width: 360px; margin: 100px auto 16px; padding: 32px 24px; border-radius: 3px; }
      #message h2 { color: #ffa100; font-weight: bold; font-size: 16px; margin: 0 0 8px; }
      #message h1 { font-size: 22px; font-weight: 300; color: rgba(0,0,0,0.6); margin: 0 0 16px;}
      #message p { line-height: 140%; margin: 16px 0 24px; font-size: 14px; }
      #message a { display: block; text-align: center; background: #039be5; text-transform: uppercase; text-decoration: none; color: white; padding: 16px; border-radius: 4px; }
      #message, #message a { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
      #load { color: rgba(0,0,0,0.4); text-align: center; font-size: 13px; }
      @media (max-width: 600px) {
        body, #message { margin-top: 0; background: white; box-shadow: none; }
        body { border-top: 16px solid #ffa100; }
      }
    </style>
  </head>
  <body>
    <div id="message">
      <h2>Welcome Pidors!</h2>
      <h1>Firebase Hosting Setup Complete</h1>
      <p>You're seeing this because you've successfully setup Firebase Hosting. Now it's time to go build something extraordinary!</p>
      <a onclick="myFunction()" target="_blank">Open Hosting Documentation</a>
    </div>
    <p id="load">Firebase SDK Loading&hellip;</p>

<!-- Insert these scripts at the bottom of the HTML, but before you use any Firebase services -->

  <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/7.22.0/firebase-app.js"></script>

  <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
  <script src="https://www.gstatic.com/firebasejs/7.22.0/firebase-analytics.js"></script>

  <!-- Add Firebase products that you want to use -->
  <script src="https://www.gstatic.com/firebasejs/7.22.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.22.0/firebase-firestore.js"></script>

    <script>

      firebase.initializeApp({
        apiKey: 'AIzaSyBczIxKNubEghukyYg-iwr5a0jqTbQqlRM',
        authDomain: 'https://empty-l33t.web.app',
        projectId: 'empty-l33t'
      });

      var db = firebase.firestore();
      var shops = db.collection("shops");
      var items = db.collection("items");

      function myFunction() {
        // shops.get().then(snapshot => {
          // snapshot.forEach(doc => {
            // console.log(doc.id);
            // doc.data().allShops.forEach(data => {
            //   if (data) {
            //     let doc = items.doc(data.id);
            //     doc.get({source: "server"}).then(doc => {
            //       // Item for shop
            //       console.log(doc.data());
            //     }).catch(error => {
            //       console.log(error);
            //     });
            //   }
            // });
          // })
        // })

        // Get items in shop
        // getItemsIn("3HUvjvozXFhXa3glp7uQ").then(items => {
        //   console.log(items);
        // }).catch(error => {
        //   console.log(error);
        // });

        // createShop({
        //   name: "CHLENO-SHOP",
        //   ownerId: "asdfasdfas",
        //   itemsAddress: "https://dns.ru",
        //   categories: ["grocery", "sec toys", "other"]
        // }).then(doc => {
        //   console.log('Created doc');
        //   console.log(doc.id);

        //   addItemsToShop(doc.id, [{
        //     localId: "weiuqiodifj",
        //     name: "chainik",
        //     description: "this is a description",
        //     price: 100,
        //     sale: 0,
        //     images: [],
        //     category: "grocery"
        //   },
        //   {
        //     localId: "bgrwewert",
        //     name: "fdsa",
        //     description: "this is a description",
        //     price: 100,
        //     sale: 0,
        //     images: [],
        //     category: "sex"
        //   },
        //   {
        //     localId: "ae5543",
        //     name: "vdsa",
        //     description: "this is a description",
        //     price: 100,
        //     sale: 0,
        //     images: [],
        //     category: "dvfu"
        //   },
        //   {
        //     localId: "grew",
        //     name: "we32",
        //     description: "this is a description",
        //     price: 100,
        //     sale: 0,
        //     images: [],
        //     category: "hahathon"
        //   }])
        // }).then(() => {
        //   console.log('Created items');
        // }).catch(error => {
        //   console.log(error);
        // })

        // getItemsDocsByCategory("dvfu").then(itemDocs => {
        //   console.log(itemDocs.docs);
        // });

        createOrder("asdfasd").then(result => {
          console.log(result);
          addItemToOrder(result.id, {
            localId : "asdgdfrsfdsg",
            shopId : "asdfasd",
            userId : "fsdregawtfdsr"
          }).then(result => {
            console.log(result);
          }).catch(error => {
            console.log(error)
          });
          addItemToOrder(result.id, {
            localId : "asdgdfrsfdsfdghjkg",
            shopId : "asdfasd",
            userId : "fsdregawtfdsr"
          }).then(result=>{
            console.log(result);
          }).catch(error => {
            console.log(error)
          });
        })

      };

      function createOrder(userId) {
        var activeOrders = db.collection("activeOrders")

        return new Promise((resolve, reject) => {
          let order = {
            courierId: "",
            creationTime: new firebase.firestore.Timestamp(1601596810, 0),
            customers: [userId],
            deliveryAddress: "",
            state: 0,
            items: [],
            recieveTime: 0
          };

          activeOrders.add(order).then(doc => {
            resolve({order: order, id: doc.id})
          }).catch(error => {
            reject(error);
          })
        })
      }

      function addItemToOrder(orderId, item) {
        var items = db.collection("activeOrders").doc(orderId).collection("items")
        return new Promise((resolve,reject)=>{resolve(items.add(item)).then(doc => {
          console.log(items); 
        }).catch(error=>{
          reject(error);
        }); 
        })
      }

      function getItemsIn(shopId) {
        var shops = db.collection("shops").doc(shopId);

        return new Promise((resolve, reject) => {
          shops.collection("items").get().then(snapshot => {
            resolve(snapshot.docs.map(doc => { return {id: doc.id, itemData: doc.data()} }));
          }).catch(error => {
            reject(error);
          })
        });;
      }

      function createShop(shopData) {
        var shops = db.collection("shops")

        return new Promise((resolve, reject) => {
          shops.add(shopData).then(doc => {
            resolve(doc)
          }).catch(error => {
            reject(error);
          });
        });
      }

      function addItemsToShop(shopId, items) {
        var itemsCollection = db.collection("shops").doc(shopId).collection("items");

        return new Promise((resolve, reject) => {
          let batch = db.batch()
          items.forEach(item => {
            let doc = itemsCollection.doc()
            doc.set(item);
          })

          batch.commit().then(() => {
            resolve();
          }).catch(error => {
            reject(error);
          });
        });
      }

// SERVER SHIT
      // function getItemsDocsByCategory(category) {
      //   var shops = db.collection("shops")

      //   return new Promise((resolve, reject) => {
      //       shops.get().then(snapshot => {
      //         var array = [];

      //         snapshot.forEach(doc => {
      //           array.push(db.collection("shops").doc(doc.id).collection("items").get());            
      //         })

      //         Promise.all(array).then(doc => {
      //           console.log(doc.map(doc => {
      //             return {
      //               docs: doc.docs
      //             }
      //           }));
      //           resolve(doc)
      //         }).catch(error => {
      //           reject(error)
      //         })
      //       })
      //     });
      // }

      

      // TODO Parse products list
    </script>

    <script></script>
  </body>
</html>
